
# What is Obfuscation?
<br>
As we advance into the world of malware, understanding payload obfuscation becomes crucial for evading static detection. This blog delves into the intricate world of payload obfuscation, a distinct technique that complements [payload encryption](https://kylerosario.com/blog/XOREncryption) in developing malware. 
<br>
IPv4/IPv6Fuscation Explained: IPv4/IPv6Fuscation stands out as an obfuscation technique where the bytes of shellcode are transformed into IPv4 or IPv6 strings. This blog will shed light on how to convert bytes from Msfvenom x64 calc shellcode into both IPv4 and IPv6 strings, offering a deeper understanding of this obfuscation approach.
<br>
IPv4Fuscation: In IPv4Fuscation, each byte of the shellcode corresponds to an octet in the resulting IPv4 string. For instance, by converting hex bytes FC, 48, 83, and E4 to decimal format, we obtain the IPv4 string 252.72.131.228. The implementation involves a function, GenerateIpv4, which takes four shellcode bytes and transforms them into an IPv4 string.
<br>
IPv6Fuscation: IPv6Fuscation, similar to IPv4Fuscation, transforms shellcode bytes into an IPv6 string. However, in this case, 16 bytes generate one IPv6 address. The conversion process doesn't require decimal format, offering flexibility. For example, the sample shellcode FC48:83E4:F0E8:C000:0000:4151:4150:5251 showcases the transformation. The implementation employs the GenerateIpv6 function, converting 16 shellcode bytes into an IPv6 address.
<br>
Implementation Details - IPv4Fuscation: To implement IPv4Fuscation, we need to ensure the shellcode is a multiple of 4 bytes. The GenerateIpv4Output function takes care of processing the shellcode, generating IPv4 addresses, and presenting the results in an array.
<br>
Implementation Details - IPv6Fuscation: IPv6Fuscation requires the shellcode to be a multiple of 16 bytes. The GenerateIpv6Output function follows a similar logic, processing the shellcode and producing an array of IPv6 addresses.
<br>
Deobfuscation Process: Once the obfuscated payload bypasses static detection, the deobfuscation process is crucial for execution. IPv4/IPv6Fuscation deobfuscation involves utilizing NTAPI functions, specifically RtlIpv4StringToAddressA and RtlIpv6StringToAddressA. These functions convert string representations of IP addresses back into binary format.
<br>
Deobfuscating IPv4Fuscation Payloads: The Ipv4Deobfuscation function reverses the IPv4Fuscation process, converting IPv4 strings back into bytes. It utilizes the RtlIpv4StringToAddressA function and allocates memory for the deobfuscated payload. The result is a binary representation ready for execution.
<br>
Deobfuscating IPv6Fuscation Payloads: Similarly, the Ipv6Deobfuscation function handles the deobfuscation of IPv6Fuscation payloads. It employs the RtlIpv6StringToAddressA function, ensuring each IPv6 address is transformed into 16 bytes for execution.
<br>
## Wrapping things up
<br>
This deep dive into Payload Obfuscation, specifically IPv4/IPv6Fuscation, unveils a powerful technique employed by malware developers. Understanding the conversion processes and deobfuscation steps is crucial for cybersecurity professionals in the ongoing battle against evolving threats. Stay vigilant, keep learning, and stay ahead in comprehending the tactics employed by adversaries. Thank you for engaging in this journey of cybersecurity exploration!